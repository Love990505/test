--1.請列出每個借閱人每年借書數量，並依借閱人編號和年度做排序
/*USER_ID需家中括號，不然會變關鍵字
  從BOOK_LEND_RECORD的借書者ID對應到MEMBER_M的USER_ID，尋找借閱人每一年借了幾本書*/
SELECT  KEEPER_ID AS 'KeeperId',USER_CNAME AS 'CName',USER_EName AS 'EName',
		YEAR(LEND_DATE) AS 'BorrowYear',count(KEEPER_ID) AS 'BorrowCnt'
FROM BOOK_LEND_RECORD JOIN MEMBER_M ON [USER_ID]=KEEPER_ID
GROUP BY KEEPER_ID,USER_CNAME,USER_EName,YEAR(LEND_DATE)
ORDER BY KeeperId,BorrowYear;


--2.列出最受歡迎的書前五名(借閱數量最多前五名)
/*BOOK_DATA的PK是Book_Id, BOOK_LEND_RECORD的FK是BOOK_ID*/
SELECT TOP(5) WITH TIES BOOK_DATA.Book_Id AS 'BookId', BOOK_NAME AS 'BookName', COUNT(KEEPER_ID) AS 'QTY'
FROM BOOK_DATA JOIN BOOK_LEND_RECORD ON BOOK_DATA.BOOK_ID=BOOK_LEND_RECORD.BOOK_ID 
GROUP BY BOOK_DATA.Book_Id, BOOK_NAME 
ORDER BY QTY DESC;


--3.以一季列出2019年每一季書籍借閱書量
SELECT CASE  WHEN MONTH(LEND_DATE) = '01'  THEN '2019/01~2019/03' 
			WHEN MONTH(LEND_DATE) = '02'  THEN '2019/01~2019/03' 
			WHEN MONTH(LEND_DATE) = '03'  THEN '2019/01~2019/03' 
			WHEN MONTH(LEND_DATE) = '04'  THEN '2019/04~2019/06' 
			WHEN MONTH(LEND_DATE) = '05'  THEN '2019/04~2019/06' 
			WHEN MONTH(LEND_DATE) = '06'  THEN '2019/04~2019/06' 
			WHEN MONTH(LEND_DATE) = '07'  THEN '2019/07~2019/09'
			WHEN MONTH(LEND_DATE) = '08'  THEN '2019/07~2019/09' 
			WHEN MONTH(LEND_DATE) = '09'  THEN '2019/07~2019/09' 
			WHEN MONTH(LEND_DATE) = '10'  THEN '2019/10~2019/12' 
			WHEN MONTH(LEND_DATE) = '11'  THEN '2019/10~2019/12'
			WHEN MONTH(LEND_DATE) = '12'  THEN '2019/10~2019/12'
			END AS [Quarter],count(KEEPER_ID) AS Cnt
FROM BOOK_LEND_RECORD 
WHERE YEAR(LEND_DATE)=2019
GROUP BY CASE  WHEN MONTH(LEND_DATE) = '01'  THEN '2019/01~2019/03' 
			WHEN MONTH(LEND_DATE) = '02'  THEN '2019/01~2019/03' 
			WHEN MONTH(LEND_DATE) = '03'  THEN '2019/01~2019/03' 
			WHEN MONTH(LEND_DATE) = '04'  THEN '2019/04~2019/06' 
			WHEN MONTH(LEND_DATE) = '05'  THEN '2019/04~2019/06' 
			WHEN MONTH(LEND_DATE) = '06'  THEN '2019/04~2019/06' 
			WHEN MONTH(LEND_DATE) = '07'  THEN '2019/07~2019/09'
			WHEN MONTH(LEND_DATE) = '08'  THEN '2019/07~2019/09' 
			WHEN MONTH(LEND_DATE) = '09'  THEN '2019/07~2019/09' 
			WHEN MONTH(LEND_DATE) = '10'  THEN '2019/10~2019/12' 
			WHEN MONTH(LEND_DATE) = '11'  THEN '2019/10~2019/12'
			WHEN MONTH(LEND_DATE) = '12'  THEN '2019/10~2019/12'
			END;


--4.撈出每個分類借閱數量前三名書本及數量
/*BOOK_CLASS的PK是BOOK_CLASS_ID,BOOK_DATA的FK是BOOK_CLASS_ID
BOOK_DATA的PK是Book_Id, BOOK_LEND_RECORD的FK是BOOK_ID*/
SELECT *
FROM(
	SELECT ROW_NUMBER()OVER(PARTITION BY BOOK_CLASS.BOOK_CLASS_NAME ORDER BY COUNT(KEEPER_ID) DESC) AS Seq,
			BOOK_CLASS_NAME AS BookClass,BOOK_LEND_RECORD.BOOK_ID AS BookId,BOOK_NAME AS BookName,COUNT(KEEPER_ID) AS Cnt
	FROM BOOK_LEND_RECORD JOIN BOOK_DATA ON BOOK_LEND_RECORD.BOOK_ID=BOOK_DATA.BOOK_ID
						JOIN BOOK_CLASS ON BOOK_CLASS.BOOK_CLASS_ID=BOOK_DATA.BOOK_CLASS_ID
	GROUP BY BOOK_CLASS_NAME,BOOK_LEND_RECORD.BOOK_ID,BOOK_NAME
) AS T
WHERE T.Seq <= '3'
ORDER BY BookClass,Cnt DESC,BookId;


--5.請列出 2016, 2017, 2018, 2019 各書籍類別的借閱數量比較
SELECT BOOK_CLASS.BOOK_CLASS_ID as ClassId,BOOK_CLASS_NAME as ClassName,
	COUNT(CASE WHEN (YEAR(LEND_DATE) = 2016) THEN 1 END) AS CNT2016,COUNT(CASE WHEN (YEAR(LEND_DATE) = 2017) THEN 2 END) AS CNT2017,
	COUNT(CASE WHEN (YEAR(LEND_DATE) = 2018) THEN 3 END) AS CNT2018,COUNT(CASE WHEN (YEAR(LEND_DATE) = 2019) THEN 4 END) AS CNT2019
FROM BOOK_DATA INNER JOIN BOOK_LEND_RECORD ON BOOK_DATA.BOOK_ID=BOOK_LEND_RECORD.BOOK_ID
					JOIN BOOK_CLASS ON  BOOK_CLASS.BOOK_CLASS_ID=BOOK_DATA.BOOK_CLASS_ID
GROUP BY BOOK_CLASS.BOOK_CLASS_ID,BOOK_CLASS_NAME
ORDER BY ClassId


--6.請使用 PIVOT 語法列出2016, 2017, 2018, 2019 各書籍類別的借閱數量比較
SELECT ClassId, BOOK_CLASS_NAME AS ClassName,ISNULL([2016],0) AS CNT2016,ISNULL([2017],0) AS CNT2017,ISNULL([2018],0) AS CNT2018,
		ISNULL([2019],0) AS CNT2019 
FROM ( SELECT BOOK_CLASS.BOOK_CLASS_ID AS ClassId,BOOK_CLASS_NAME,YEAR(LEND_DATE) AS Y,COUNT(KEEPER_ID) AS QTY
		FROM  BOOK_DATA INNER JOIN BOOK_LEND_RECORD ON BOOK_DATA.BOOK_ID=BOOK_LEND_RECORD.BOOK_ID
		JOIN BOOK_CLASS ON  BOOK_CLASS.BOOK_CLASS_ID=BOOK_DATA.BOOK_CLASS_ID
		 GROUP BY BOOK_CLASS.BOOK_CLASS_ID,BOOK_CLASS_NAME,YEAR(LEND_DATE)) AS D 
PIVOT(SUM(Qty) FOR D.Y IN([2016],[2017],[2018],[2019])) AS pvt
ORDER BY ClassId;


--7.請查詢出李四的借書紀錄，其中包含書本ID、購書日期(yyyy/mm/dd)、借閱日期
SELECT BOOK_DATA.BOOK_ID AS 書本ID, CONVERT(varchar(100), BOOK_BOUGHT_DATE, 111) AS 購書日期,
		CONVERT(varchar(100),LEND_DATE, 111) AS 借閱日期,BOOK_CLASS.BOOK_CLASS_ID+'-'+BOOK_CLASS_NAME AS 書籍類別,
		[USER_ID]+'-'+USER_CNAME+'('+USER_ENAME+')' AS 借閱人,BOOK_STATUS+CODE_NAME AS 狀態,BOOK_AMOUNT AS 購書金額
FROM BOOK_DATA INNER JOIN BOOK_LEND_RECORD ON BOOK_DATA.BOOK_ID=BOOK_LEND_RECORD.BOOK_ID
			JOIN BOOK_CLASS ON  BOOK_CLASS.BOOK_CLASS_ID=BOOK_DATA.BOOK_CLASS_ID
			JOIN MEMBER_M ON [USER_ID]=KEEPER_ID
			JOIN BOOK_CODE ON CODE_ID=BOOK_STATUS  
WHERE USER_CNAME='李四'
ORDER BY 書本ID DESC,購書金額 DESC


--8.新增一筆借閱紀錄，借書人為李四，書本ID為2004，並修改借閱日期為2019/01/02
INSERT INTO BOOK_LEND_RECORD (BOOK_ID,KEEPER_ID,LEND_DATE)
VALUES (2004, '0002', '2018-02-02 00:00:00.000');

UPDATE BOOK_LEND_RECORD
SET LEND_DATE = '2019/01/02 00:00:00.000'
WHERE BOOK_ID=2004
AND LEND_DATE='2018/02/02 00:00:00.000'


--9.請將題8新增的借閱紀錄(書本ID=2004)刪除
DELETE BOOK_LEND_RECORD
WHERE BOOK_ID=2004
AND LEND_DATE='2019/01/02 00:00:00.000'
